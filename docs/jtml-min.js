!function(){"use strict";function t(t){const n=[];for(const r of t){const t=e(r);t&&n.push(t)}return n}function e(e){if(e.nodeType===Node.TEXT_NODE){const t=e.textContent;return t&&t.length?{type:"text",raw:t}:null}if(e.nodeType!==Node.ELEMENT_NODE)return null;const r=e.getAttribute("jt-foreach"),o=n(e.getAttribute("jt-text")),c=function(t){const e=[];for(let r of t.attributes)if(r.name.startsWith("jt-attr:")){const[,t]=r.name.split(":"),o=n(r.value);e.push((e,n)=>{e.setAttribute(t,o(n))})}return e}(e),i=function(t){const e=t.getAttribute("jt-if");if(!e)return null;const[n,r,o]=e.trim().split(/\s+/),c={eq:(t,e)=>t===e,neq:(t,e)=>t!==e,gt:(t,e)=>t>e,lt:(t,e)=>t<e,gte:(t,e)=>t>=e,lte:(t,e)=>t<=e}[r];if(!c)throw Error("Unknown operator: "+r);let i;i=/^'.*'$/.test(o)?o.slice(1,-1):isNaN(Number(o))?t=>t[o]:Number(o);return t=>{const e=(t=>t[n])(t),r="function"==typeof i?i(t):i;return c(e,r)}}(e);return{type:"element",node:e,foreach:r,text:o,ifExpr:i,binders:c,children:t(e.childNodes)}}function n(t){if(""===t)return t=>t;if(!t||!t.length)return;const e=[],n=t.length;let r=0,c=0;for(;r<n;){if("{"!==t[r]){r++;continue}r>c&&e.push({type:"text",value:t.slice(c,r)});const o=r+1;let i=o;for(;i<n&&"}"!==t[i];)i++;if(i===n)return e.push({type:"text",value:t.slice(r)}),e;e.push({type:"path",value:t.slice(o,i)}),r=i+1,c=r}return c<n&&e.push({type:"text",value:t.slice(c)}),t=>{let n="";if(1===e.length){const r=o(t,e[0].value);n+=r?r+"":e[0].value}else for(const r of e)if("text"!==r.type){if("path"===r.type){const e=o(t,r.value);n+=e?e+"":r.value}}else n+=r.value;return n}}function r(t,e,n){const{type:c,node:i,foreach:u,text:s,ifExpr:a,binders:l,children:f}=t;if("text"===c)return document.createTextNode(t.raw);if(a&&!a(e))return;if(null!==u){const t=o(e,u);if(!Array.isArray(t))return null;const c=document.createDocumentFragment();for(const e of t){const t=i.cloneNode(!1);for(const o of f){const c=r(o,e,n);n&&c&&t.appendChild(c)}c.appendChild(t)}return c}const d=n?i.cloneNode(!1):i;if(s){const t=s(e);t&&(d.textContent=t)}for(const t of l)t(d,e);for(const t of f){const o=r(t,e,n);n&&o&&d.appendChild(o)}return d}function o(t,e){if(""===e)return t;let n=t;for(const t of e.split(".")){if(!n)return;n=n[t]}return n}const c=["jt-click","jt-submit","jt-input","jt-change","jt-load"],i={data:{},add(t,e){this.data[t]=e},get(t){return this.data[t]}},u={apply:function(t=document.body){const e=t.querySelectorAll(`[${c.join("],[")}]`);for(const t of e)t._redered||(s(t),t._redered=!0)},store:i};function s(t){const e=f(t);for(const n of c){const r=t.getAttribute(n);null!==r&&("jt-load"!==n?t.addEventListener(n.slice(3),n=>a(t,r,e,n)):a(t,r,e))}}async function a(t,e,n,r){if(r&&r.preventDefault(),!1===await d(e,t,r))return;let o={};const c=i.get(t.getAttribute("jt-source"));if(c&&(o=c),["FORM","A"].includes(t.tagName)){const e=await async function(t){const e=p(t,"jt-loading"),n=p(t,"jt-error");h(e),y(n);try{const r=await async function(t){const{url:e,options:n}=function(t){let e=t.getAttribute("action")||t.getAttribute("href");const n=(t.getAttribute("method")||"GET").toUpperCase(),r={method:n,headers:{}};if(["POST","PUT","PATCH"].includes(n)){const e=function(t){const e=new FormData(t),n={};for(const[t,r]of e.entries())n[t]=r;return n}(t);r.body=JSON.stringify(e),r.headers={"Content-Type":"application/json"}}if("GET"===n){const n=new FormData(t),r=new URLSearchParams(n),o=new URL(e,window.location.href);o.search=r,e=""+o}return{url:e,options:r}}(t);try{await d(t.getAttribute("jt-pre-request-fn"),t,n);const r=await fetch(e,n),o=await function(t){return t.headers.get("Content-Type").includes("text/html")?t.text():t.json()}(r);if(await d(t.getAttribute("jt-post-request-fn"),t,r,o),!r.ok)throw{status:r.status,body:o};return o}catch(n){throw await d(t.getAttribute("jt-request-error-fn"),t,n),console.error("[jtml] fetch failed:",e,n),n}}(t);return y(e),y(n),r}catch(t){y(e),h(n),console.error("Form request failed:",t)}}(t);if(!e)return;const r=t.getAttribute("jt-store");return r&&i.add(r,e),void l(t,n,o?{...o,...e}:e)}l(t,n,o)}function l(t,e,n){e&&e(n);const r=function(t,e){const n=t.getAttribute(e);if(!n)return null;try{return document.querySelectorAll(n)}catch{return console.warn(`[jtml] Invalid ${e} selector "${n}"`),null}}(t,"jt-after")||[];for(const t of r)a(t,"",f(t))}function f(e){const n=function(e){if(e.hasAttribute("jt-html"))return t=>t;const n=p(e,"jt-render");if(!n)return;if(n._compiled)return n._compiled;const o=function(e){const n=e instanceof HTMLTemplateElement,o=t(n?e.content.childNodes:[e]);return function(t){const e=n?document.createDocumentFragment():null;for(const c of o){const o=r(c,t,n);n&&o&&e.appendChild(o)}return e}}(n);return n._compiled=o,o}(e);if(!n)return;const o=p(e,"jt-target")||e,c={replace:(t,e)=>"string"==typeof e?t.innerHTML=e:t.replaceChildren(e),append:(t,e)=>"string"==typeof e?t.innerHTML+=e:t.appendChild(e),prepend:(t,e)=>"string"==typeof e?t.innerHTML=e+t.innerHTML:t.prepend(e)}[e.getAttribute("jt-swap")||"replace"];return t=>function(t,e,n,r){const o=t(e);o&&(n(r,o),u.apply(r))}(n,t,c,o)}async function d(t,...e){const n=window[t];return n&&n(...e)}function p(t,e){const n=t.getAttribute(e);if(!n)return null;try{return document.querySelector(n)}catch{return console.warn(`[jtml] Invalid ${e} selector "${n}"`),null}}function h(t){t&&(t.style.display="")}function y(t){t&&(t.style.display="none")}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>u.apply()):u.apply(),window.JTML=u}();
